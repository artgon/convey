version: 2.1

jobs:
  lint:
    docker:
      - image: cimg/rust:1.51.0
    steps:
      - checkout
      - run:
          name: Install cargo fmt
          command: rustup component add rustfmt
      - run:
          name: Run lint
          command: cargo fmt -- --check

  clippy:
    parameters:
      toolchain:
        description: rust toolchain
        type: string
    machine:
      image: ubuntu-2004:202104-01
    steps:
      - checkout
      - run: >
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | 
          sh -s -- -v -y --profile minimal --default-toolchain <<parameters.toolchain>>
      - run: sudo apt-get update && sudo apt install linux-headers-$(uname -r)
      - run: sudo apt install libelf-dev
      - run:
          name: Install cargo clippy
          command: $HOME/.cargo/bin/rustup component add clippy
      - run:
          name: Run Clippy
          command: $HOME/.cargo/bin/cargo clippy -- -W clippy::pedantic

  build_and_test:
    parameters:
      toolchain:
        description: rust toolchain
        type: string
    machine:
      image: ubuntu-2004:202104-01
    steps:
      - checkout
      - run: >
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | 
          sh -s -- -v -y --profile minimal --default-toolchain <<parameters.toolchain>>
      - run: sudo apt-get update && sudo apt install linux-headers-$(uname -r)
      - run: sudo apt install libelf-dev
      - run: $HOME/.cargo/bin/cargo build --release
      - run: sudo -E $HOME/.cargo/bin/cargo test
      
workflows:
  version: 2.1

  build:
    jobs:
      - lint
      - clippy:
          matrix:
            parameters:
              toolchain: ["stable"]
      - build_and_test:
          matrix:
            parameters:
              toolchain: ["stable"]